import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import englishMessages from 'ra-language-english';
import romanianMessages from 'ra-language-romanian';
import russianMessages from 'ra-language-russian';

// Normalize RA placeholders from "%{var}" to i18next format "{{var}}"
const fixPlaceholders = (obj) =>
  !obj || typeof obj !== 'object' ? obj :
  Object.fromEntries(Object.entries(obj).map(([k, v]) =>
    [k, typeof v === 'string' ? v.replace(/%\{(.*?)\}/g, '{{$1}}') :
         v && typeof v === 'object' && !Array.isArray(v) ? fixPlaceholders(v) : v]
  ));

// LocalStorage key for persisted language
const LS_KEY = 'app_lang';
const storedLang = typeof window !== 'undefined' ? window.localStorage.getItem(LS_KEY) : null;

const resources = {
  en: {
    ra: fixPlaceholders(englishMessages.ra || englishMessages),
    common: {
      welcome: 'Welcome to School Portal', connect: 'Connect',
      signupTitle: 'Student Signup', firstName: 'First Name', lastName: 'Last Name',
      email: 'Email', phone: 'Phone', dob: 'Date of Birth', status: 'Status',
      selectStatus: 'Select Status', active: 'Active', inactive: 'Inactive',
      signUp: 'Sign Up', submitting: 'Submitting...', signupSuccess: 'Registration successful',
      signupFailed: 'Registration failed', networkError: 'Network error. Please try again.',
      debugLabel: 'Debug info',
    },
    validation: {
      required: 'This field is required', invalidPhone: 'Invalid phone number',
      invalidEmail: 'Invalid email address', invalidDob: 'You cannot select a future date',
      tooYoung: 'Must be at least {{years}} years old', tooOld: 'Date cannot be more than {{years}} years ago',
      invalidHireDate: 'Invalid hire date', atLeastOneRecurrence: 'At least one recurrence is required',
      requiredField: 'This field is required', practiceEnrollmentRequired: 'Practice lesson requires enrollment',
      outsideAvailability: 'Selected time is outside instructor availability', categoryMismatch: 'Resource category does not match course type',
      instructorLicenseMismatch: 'Instructor license does not match course category', instructorConflict: 'Instructor has another lesson at this time',
      studentConflict: 'Student has another lesson at this time', resourceConflict: 'Resource is already booked at this time',
      theoryOnly: 'Scheduled classes can only be created for theory courses', classroomResourceRequired: 'Classroom resource is required for scheduled classes',
      studentNotEnrolledToCourseNames: 'Student is not enrolled in course: {{courseNames}}',
    },
    errors: {
      required: 'This field is required.', invalidDob: 'Please enter a valid date.',
      dobTooOld: 'Date of birth cannot be more than 125 years ago.',
      tooYoung: 'Must be at least 15 years old.', invalidDate: 'Please enter a valid date.',
      hireDateTooOld: 'Hire date cannot be more than 125 years ago.',
      futureNotAllowed: 'Future dates are not allowed.',
    },
    admin: {
      resources: {
        students: { name: 'Students' },
        instructors: { name: 'Instructors' },
        vehicles: { name: 'Vehicles' },
        classes: { name: 'Courses' },
        payments: { name: 'Payments' },
        scheduledclasses: { name: 'Scheduled Classes', helper: 'Create a scheduled class to start planning lessons.', create: 'Create Scheduled Class' },
        scheduledclasspatterns: { name: 'Scheduled Class Patterns' },
      },
      fields: {
        id: 'ID',
        name: 'Name',
        amount: 'Amount',
        enrollment: 'Enrollment',
        first_name: 'First Name',
        last_name: 'Last Name',
        email: 'Email',
        phone_number: 'Phone Number',
        date_of_birth: 'Date of Birth',
        enrollment_date: 'Enrollment Date',
        status: 'Status',
        hire_date: 'Hire Date',
        license_categories: 'License Categories',
        make: 'Make',
        model: 'Model',
        license_plate: 'License Plate',
        year: 'Year',
        category: 'Category',
        is_available: 'Available',
        price: 'Price',
        required_lessons: 'Required Lessons',
        payment_date: 'Payment Date',
        payment_method: 'Payment Method',
        description: 'Description',
        course: 'Course',
        resource: 'Resource',
        recurrences: 'Recurrences',
        day: 'Day',
        time: 'Time',
        num_lessons: 'Number of Lessons',
        duration_minutes: 'Duration (minutes)',
        max_students: 'Max Students',
        start_date: 'Start Date',
        instructor: 'Instructor',
        pattern: 'Pattern',
        scheduled_time: 'Scheduled Time',
        current_enrollment: 'Current Enrollment',
        available_spots: 'Available Spots',
        students: 'Students',
        default_duration_minutes: 'Default Duration (min)',
        default_max_students: 'Default Max Students',
      },
      actions: {
        export: 'Export',
        import: 'Import',
        create: 'Create',
        edit: 'Edit',
      },
      empty: {
        students: 'No students yet. Create one or import a batch.', instructors: 'No instructors yet. Create one or import a batch.',
        vehicles: 'No vehicles yet. Create one or import a batch.', classes: 'No courses yet. Create one or import a batch.',
        payments: 'No payments yet. Create one or import a batch.', scheduledclasses: 'No scheduled classes yet. Create one or import a batch.',
        scheduledclasspatterns: 'No scheduled class patterns yet. Create one to start planning recurring lessons.',
      },
      invite: {
        students: 'Create a new student or import a CSV to get started.', instructors: 'Create a new instructor or import a CSV to get started.',
        vehicles: 'Create a new vehicle or import a CSV to get started.', classes: 'Create a new course or import a CSV to get started.',
        payments: 'Create a new payment or import a CSV to get started.', scheduledclasses: 'Create a new scheduled class or import a CSV to get started.',
        scheduledclasspatterns: 'Create a new scheduled class pattern to start planning recurring lessons.',
      },
      filters: {
        lastActivity: 'Last activity',
        today: 'Today',
        thisWeek: 'This week',
        lastWeek: 'Last week',
        thisMonth: 'This month',
        lastMonth: 'Last month',
        earlier: 'Earlier',
        status: 'Status',
        active: 'Active',
        inactive: 'Inactive',
        graduated: 'Graduated',
      },
    },
  },
  ro: {
    ra: fixPlaceholders(romanianMessages.default?.ra || romanianMessages.ra || romanianMessages),
    common: {
      welcome: 'Bine ați venit la Portalul Școlii', connect: 'Conectează-te',
      signupTitle: 'Înregistrare Student', firstName: 'Prenume', lastName: 'Nume',
      email: 'Email', phone: 'Telefon', dob: 'Data nașterii', status: 'Statut',
      selectStatus: 'Selectați statutul', active: 'Activ', inactive: 'Inactiv',
      signUp: 'Înregistrează-te', submitting: 'Se trimite...', signupSuccess: 'Înregistrare reușită',
      signupFailed: 'Înregistrare eșuată', networkError: 'Eroare de rețea. Reîncercați.',
      debugLabel: 'Informații debug',
    },
    validation: {
      required: 'Acest câmp este obligatoriu',
      invalidPhone: 'Număr de telefon invalid',
      invalidEmail: 'Adresă de email invalidă',
      invalidDob: 'Nu puteți selecta o dată din viitor',
      tooYoung: 'Trebuie să aveți cel puțin {{years}} ani',
      tooOld: 'Data nu poate fi mai veche de {{years}} ani',
      invalidHireDate: 'Data angajării invalidă', atLeastOneRecurrence: 'Cel puțin o recurență este necesară',
      requiredField: 'Acest câmp este obligatoriu', practiceEnrollmentRequired: 'Lecția practică necesită înscriere',
      outsideAvailability: 'Ora selectată este în afara disponibilității instructorului', categoryMismatch: 'Categoria resursei nu se potrivește cu tipul cursului',
      instructorLicenseMismatch: 'Licența instructorului nu se potrivește cu categoria cursului', instructorConflict: 'Instructorul are altă lecție la această oră',
      studentConflict: 'Studentul are altă lecție la această oră', resourceConflict: 'Resursa este deja rezervată la această oră',
      theoryOnly: 'Clasele programate pot fi create doar pentru cursuri teoretice', classroomResourceRequired: 'Resursa de sală de clasă este necesară pentru clasele programate',
      studentNotEnrolledToCourseNames: 'Studentul nu este înscris la curs: {{courseNames}}',
    },
    errors: {
      required: 'Acest câmp este obligatoriu.',
      invalidDob: 'Introduceți o dată validă.',
      dobTooOld: 'Data nașterii nu poate fi mai veche de 125 de ani.',
      tooYoung: 'Trebuie să aveți cel puțin 15 ani.',
      invalidDate: 'Introduceți o dată validă.',
      hireDateTooOld: 'Data angajării nu poate fi mai veche de 125 de ani.',
      futureNotAllowed: 'Datele din viitor nu sunt permise.',
    },
    admin: {
      resources: {
        students: { name: 'Studenți' },
        instructors: { name: 'Instructori' },
        vehicles: { name: 'Vehicule' },
        classes: { name: 'Cursuri' },
        payments: { name: 'Plăți' },
        scheduledclasses: { name: 'Clase Programate', helper: 'Creați o clasă programată pentru a începe planificarea lecțiilor.', create: 'Creați Clasă Programată' },
        scheduledclasspatterns: { name: 'Modele Clase Programate' },
      },
      fields: {
        id: 'ID',
        name: 'Nume',
        amount: 'Sumă',
        enrollment: 'Înrolare',
        first_name: 'Prenume',
        last_name: 'Nume',
        email: 'Email',
        phone_number: 'Telefon',
        date_of_birth: 'Data nașterii',
        enrollment_date: 'Data înscrierii',
        status: 'Statut',
        hire_date: 'Data angajării',
        license_categories: 'Categorii licență',
        make: 'Marcă',
        model: 'Model',
        license_plate: 'Număr înmatriculare',
        year: 'An',
        category: 'Categorie',
        is_available: 'Disponibil',
        price: 'Preț',
        required_lessons: 'Lecții necesare',
        payment_date: 'Data plății',
        payment_method: 'Metodă plată',
        description: 'Descriere',
        course: 'Curs',
        resource: 'Resursă',
        recurrences: 'Recurențe',
        day: 'Zi',
        time: 'Oră',
        num_lessons: 'Număr de Lecții',
        duration_minutes: 'Durată (minute)',
        max_students: 'Max Studenți',
        start_date: 'Data Început',
        instructor: 'Instructor',
        pattern: 'Model',
        scheduled_time: 'Ora Programată',
        current_enrollment: 'Înscriere Curentă',
        available_spots: 'Locuri Disponibile',
        students: 'Studenți',
        default_duration_minutes: 'Durată Implicită (min)',
        default_max_students: 'Max Studenți Implicit',
      },
      actions: {
        export: 'Exportă',
        import: 'Importă',
        create: 'Creează',
        edit: 'Editează',
      },
      empty: {
        students: 'Niciun student încă. Creați sau importați un lot.', instructors: 'Niciun instructor încă. Creați sau importați un lot.',
        vehicles: 'Niciun vehicul încă. Creați sau importați un lot.', classes: 'Niciun curs încă. Creați sau importați un lot.',
        payments: 'Nicio plată încă. Creați sau importați un lot.', scheduledclasses: 'Nicio clasă programată încă. Creați sau importați un lot.',
        scheduledclasspatterns: 'Niciun model de clasă programată încă. Creați unul pentru a începe planificarea lecțiilor recurente.',
      },
      invite: {
        students: 'Creați un student nou sau importați un CSV pentru a începe.', instructors: 'Creați un instructor nou sau importați un CSV pentru a începe.',
        vehicles: 'Creați un vehicul nou sau importați un CSV pentru a începe.', classes: 'Creați un curs nou sau importați un CSV pentru a începe.',
        payments: 'Creați o plată nouă sau importați un CSV pentru a începe.', scheduledclasses: 'Creați o clasă programată nouă sau importați un CSV pentru a începe.',
        scheduledclasspatterns: 'Creați un model nou de clasă programată pentru a începe planificarea lecțiilor recurente.',
      },
      filters: {
        lastActivity: 'Ultima activitate',
        today: 'Astăzi',
        thisWeek: 'Săptămâna aceasta',
        lastWeek: 'Săptămâna trecută',
        thisMonth: 'Luna aceasta',
        lastMonth: 'Luna trecută',
        earlier: 'Mai devreme',
        status: 'Statut',
        active: 'Activ',
        inactive: 'Inactiv',
        graduated: 'Absolvit',
      },
    },
  },
  ru: {
    ra: fixPlaceholders(russianMessages.ra || russianMessages),
    common: {
      welcome: 'Добро пожаловать в школьный портал', connect: 'Подключиться', signupTitle: 'Регистрация студента',
      firstName: 'Имя', lastName: 'Фамилия', email: 'Эл. почта', phone: 'Телефон', dob: 'Дата рождения', status: 'Статус',
      selectStatus: 'Выберите статус', active: 'Активный', inactive: 'Неактивный', signUp: 'Зарегистрироваться',
      submitting: 'Отправка...', signupSuccess: 'Регистрация успешна', signupFailed: 'Ошибка регистрации',
      networkError: 'Сетевая ошибка. Повторите попытку.', debugLabel: 'Отладочная информация',
    },
    validation: {
      required: 'Это обязательное поле', invalidPhone: 'Неверный номер телефона', invalidEmail: 'Неверный адрес электронной почты',
      invalidDob: 'Вы не можете выбрать дату в будущем', tooYoung: 'Вам должно быть не менее {{years}} лет',
      tooOld: 'Дата не может быть старше {{years}} лет', invalidHireDate: 'Неверная дата приема на работу', atLeastOneRecurrence: 'Требуется хотя бы одно повторение',
      requiredField: 'Это поле обязательно для заполнения', practiceEnrollmentRequired: 'Практическое занятие требует записи',
      outsideAvailability: 'Выбранное время находится вне доступности инструктора', categoryMismatch: 'Категория ресурса не соответствует типу курса',
      instructorLicenseMismatch: 'Лицензия инструктора не соответствует категории курса', instructorConflict: 'У инструктора есть другое занятие в это время',
      studentConflict: 'У студента есть другое занятие в это время', resourceConflict: 'Ресурс уже забронирован на это время',
      theoryOnly: 'Запланированные классы можно создавать только для теоретических курсов', classroomResourceRequired: 'Для запланированных классов требуется ресурс класса',
      studentNotEnrolledToCourseNames: 'Студент не записан на курс: {{courseNames}}',
    },
    errors: {
      required: 'Это обязательное поле.', invalidDob: 'Введите корректную дату.', dobTooOld: 'Дата рождения не может быть старше 125 лет.',
      tooYoung: 'Должно быть не менее 15 лет.', invalidDate: 'Введите корректную дату.', hireDateTooOld: 'Дата приема на работу не может быть старше 125 лет.',
      futureNotAllowed: 'Будущие даты недопустимы.',
    },
    admin: {
      resources: {
        students: { name: 'Студенты' }, instructors: { name: 'Инструкторы' }, vehicles: { name: 'Транспорт' },
        classes: { name: 'Занятия' }, payments: { name: 'Платежи' }, scheduledclasses: { name: 'Запланированные Классы', helper: 'Создайте запланированный класс для начала планирования уроков.', create: 'Создать Запланированный Класс' },
        scheduledclasspatterns: { name: 'Шаблоны Запланированных Классов' },
      },
      fields: {
        id: 'ID', name: 'Название', amount: 'Сумма', enrollment: 'Зачисление', first_name: 'Имя', last_name: 'Фамилия',
        email: 'Эл. почта', phone_number: 'Телефон', date_of_birth: 'Дата рождения', enrollment_date: 'Дата зачисления',
        status: 'Статус', hire_date: 'Дата найма', license_categories: 'Категории лицензии', make: 'Марка', model: 'Модель',
        license_plate: 'Номерной знак', year: 'Год', category: 'Категория', is_available: 'Доступно', price: 'Цена',
        required_lessons: 'Необходимые уроки', payment_date: 'Дата платежа', payment_method: 'Способ оплаты',
        description: 'Описание', course: 'Курс', resource: 'Ресурс', recurrences: 'Повторения', day: 'День', time: 'Время',
        num_lessons: 'Количество Уроков', duration_minutes: 'Длительность (минуты)', max_students: 'Макс Студентов',
        start_date: 'Дата Начала', instructor: 'Инструктор', pattern: 'Шаблон', scheduled_time: 'Запланированное Время',
        current_enrollment: 'Текущая Запись', available_spots: 'Доступные Места', students: 'Студенты',
        default_duration_minutes: 'Длительность по Умолчанию (мин)', default_max_students: 'Макс Студентов по Умолчанию',
      },
      actions: { export: 'Экспорт', import: 'Импорт', create: 'Создать', edit: 'Редактировать' },
      empty: {
        students: 'Пока нет студентов. Создайте или импортируйте пакет.', instructors: 'Пока нет инструкторов. Создайте или импортируйте пакет.',
        vehicles: 'Пока нет транспортных средств. Создайте или импортируйте пакет.', classes: 'Пока нет курсов. Создайте или импортируйте пакет.',
        payments: 'Пока нет платежей. Создайте или импортируйте пакет.', scheduledclasses: 'Пока нет запланированных классов. Создайте или импортируйте пакет.',
        scheduledclasspatterns: 'Пока нет шаблонов запланированных классов. Создайте один для начала планирования повторяющихся уроков.',
      },
      invite: {
        students: 'Создайте нового студента или импортируйте CSV, чтобы начать.', instructors: 'Создайте нового инструктора или импортируйте CSV, чтобы начать.',
        vehicles: 'Создайте новое транспортное средство или импортируйте CSV, чтобы начать.', classes: 'Создайте новый курс или импортируйте CSV, чтобы начать.',
        payments: 'Создайте новый платеж или импортируйте CSV, чтобы начать.', scheduledclasses: 'Создайте новый запланированный класс или импортируйте CSV, чтобы начать.',
        scheduledclasspatterns: 'Создайте новый шаблон запланированного класса для начала планирования повторяющихся уроков.',
      },
      filters: {
        lastActivity: 'Последняя активность', today: 'Сегодня', thisWeek: 'На этой неделе', lastWeek: 'На прошлой неделе',
        thisMonth: 'В этом месяце', lastMonth: 'В прошлом месяце', earlier: 'Ранее', status: 'Статус',
        active: 'Активный', inactive: 'Неактивный', graduated: 'Выпустился',
      },
    },
  },
};

i18n
  .use(initReactI18next)
  .init({
    resources,
    lng: storedLang || 'en',
    fallbackLng: 'en',
  ns: ['ra', 'common', 'validation', 'errors', 'admin'],
    defaultNS: 'common',
    interpolation: {
      escapeValue: false,
    },
  });

// Persist language selection
i18n.on('languageChanged', (lng) => {
  try { window.localStorage.setItem(LS_KEY, lng); } catch (_) {}
});

export default i18n;
